#!/bin/bash
#
# This is a `main` module of the SmartPrompt engine.
#
# Smart Prompt @SP_VERSION@
# Copyright (c) 2013 Alex Turbov <i.zaufi@gmail.com>
#
# This file is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; either version 3 of the License, or
# (at your option) any later version.
#

# Load configuration file
if [ -f @SMART_PROMPT_CONFIG@ ]; then
    source @SMART_PROMPT_CONFIG@
fi

# Load user level overrides
if [ -f ~/.@PROJECT_NAME@rc ]; then
    source ~/.@PROJECT_NAME@rc
fi

# Declare a global associative array to be filled by found plugins
declare -A SMART_PROMPT_PLUGINS

# Loading user plugins
if [ -d ~/.@PROJECT_NAME@.d ]; then
    for plugin in `ls -v1 ~/.@PROJECT_NAME@.d/[0-9][0-9]*.sh`; do
        source ${plugin}
    done
fi

# Loading plugins
if [ -d @SP_CONTEXT_CHECKERS_DIR@ ]; then
    for plugin in `ls -v1 @SP_CONTEXT_CHECKERS_DIR@/[0-9][0-9]*.sh`; do
        source ${plugin}
    done
fi


function _eval_color_string
{
    local colors_str=$1
    local output_var=$2

    local _colors
    typeset -A _colors
    _colors['black']='\[\e[30m\]'
    _colors['red']='\[\e[31m\]'
    _colors['green']='\[\e[32\]'
    _colors['brown']='\[\e[33m\]'
    _colors['blue']='\[\e[34m\]'
    _colors['magenta']='\[\e[35m\]'
    _colors['cyan']='\[\e[36m\]'
    _colors['grey']='\[\e[37m\]'

    _colors['dark-grey']='\[\e[30;1m\]'
    _colors['bright-red']='\[\e[31;1m\]'
    _colors['bright-green']='\[\e[32;1m\]'
    _colors['yellow']='\[\e[33;1m\]'
    _colors['bright-blue']='\[\e[34;1m\]'
    _colors['bright-magenta']='\[\e[35;1m\]'
    _colors['bright-cyan']='\[\e[36;1m\]'
    _colors['white']='\[\e[37;1m\]'

    _colors['reset']='\[\e[0m\]'
    _colors['bold']='\[\e[1m\]'
    _colors['itallic']='\[\e[3m\]'
    _colors['underscore']='\[\e[4m\]'
    _colors['reverse']='\[\e[7m\]'

    local _result_str
    for c in ${colors_str}; do
        _result_str="${_result_str}\${_colors[${c}]}"
    done
    eval "${output_var}=${_result_str}"
}

function _@PROJECT_NAME@()
{
    local sp_path
    local sp_user
    local sp_reset

    # Get configured colors (or defaults)
    # NOTE Before set desired color, make sure there is no
    # other styles in effect...it is why `reset' is a leading
    # (and hardcoded) "color" in a sequence...
    _eval_color_string "reset ${SP_PATH:-bright-blue}" sp_path
    if [[ ${EUID} != 0 ]]; then
        _eval_color_string "reset ${SP_USER:-bright-green}" sp_user
    else
        _eval_color_string "reset ${SP_SUSER:-bright-red}" sp_user
    fi
    _eval_color_string 'reset' sp_reset

    # Set configuration variables to defaults if needed
    local start="${sp_user}\u@\h${sp_path} \w"
    local end=" \$ ${sp_reset}"
    local middle=''

    # Iterate over registered plugins and collect strings to be appended to PS1
    for checker in "${!SMART_PROMPT_PLUGINS[@]}"; do
        if `${checker}`; then
            middle=`${SMART_PROMPT_PLUGINS[$checker]}`
            break
        fi
    done
    if [ -z "$middle" ]; then
        PS1="${start}${end}"
    else
        PS1="${start}|${middle}${sp_path}|${end}"
    fi
}

export PROMPT_COMMAND=_@PROJECT_NAME@

# kate: hl bash;
